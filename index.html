<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Les entreprises françaises</title>
    <link rel="stylesheet" href="style_site.css">
</head>
<body>
    <h1>Les entreprises françaises</h1>
    <div class="search-container">
        <input type="text" id="searchAPE" placeholder="Entrez un code APE...">
        <input type="text" id="searchSIRET" placeholder="Entrez un numéro de SIRET...">
        <input type="text" id="searchPostal" placeholder="Entrez un code postal...">
    </div>
    <div id="csvData"></div>
     <div id="autreCsvData"><button id="change" onclick="window.location.href='autre.html'">Voir notre BDD</button></div>
    <button id="loadMore">Charger plus</button>
    
 

    <script>
        let currentIndex = 0;
        const batchSize = 500;
        let data = [];

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = lines[i].split(',');
                const entry = {};

                for (let j = 0; j < headers.length; j++) {
                    entry[headers[j]] = values[j];
                }
                data.push(entry);
            }

            return data;
        }

        // Colonnes à afficher et leurs labels
        const columns = [
            { key: "siret", label: "SIRET" },
            { key: "nom", label: "Nom de l'établissement" },
            { key: "ville", label: "Ville" },
            { key: "code_postal", label: "Code postal" },
            { key: "activite", label: "Activité" },
            { key: "effectif", label: "Effectif" }
        ];


        let sortColumn = null;
        let sortAsc = true;

        function displayData(data, startIndex, endIndex) {
            const container = document.getElementById('csvData');
            container.innerHTML = '';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            // En-tête cliquable
            const headerRow = document.createElement('tr');
            columns.forEach((col, idx) => {
                const th = document.createElement('th');
                th.textContent = col.label;
                th.style.cursor = 'pointer';
                th.onclick = function () {
                    if (sortColumn === col.key) {
                        sortAsc = !sortAsc;
                    } else {
                        sortColumn = col.key;
                        sortAsc = true;
                    }
                    sortAndDisplay();
                };
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Lignes
            for (let i = startIndex; i < endIndex && i < data.length; i++) {
                const entry = data[i];
                const row = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    td.textContent = entry[col.key] || '';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            }
            table.appendChild(tbody);

            container.appendChild(table);
        }

        function sortAndDisplay() {
            let sortedData = [...data];
            if (sortColumn) {
                sortedData.sort((a, b) => {
                    const valA = (a[sortColumn] || '').toUpperCase();
                    const valB = (b[sortColumn] || '').toUpperCase();
                    if (valA < valB) return sortAsc ? -1 : 1;
                    if (valA > valB) return sortAsc ? 1 : -1;
                    return 0;
                });
            }
            displayData(sortedData, 0, batchSize);
        }

        function filterData(data, apeTerm, siretTerm, postalTerm) {
            return data.filter(entry =>
                (entry.activitePrincipaleEtablissement || '').toUpperCase().includes(apeTerm) &&
                (entry.siret || '').toUpperCase().includes(siretTerm) &&
                (entry.codePostalEtablissement || '').toUpperCase().includes(postalTerm)
            );
        }

        fetch('etablissements_insee.csv')
            .then(response => {
                if (!response.ok) throw new Error('Erreur réseau');
                return response.text();
            })
            .then(csvText => {
                data = parseCSV(csvText);

                // Fusionne les colonnes de nom si besoin
                data.forEach(entry => {
                    entry.nom_etablissement = entry.denominationUniteLegale || entry.nomUniteLegale || '';
                });

                sortAndDisplay();

                document.getElementById('loadMore').style.display = 'none'; // Cache le bouton "Charger plus"
            })
            .catch(error => console.error('Erreur lors de la récupération du fichier CSV:', error));
    </script>
</body>
</html>
